---
// src/components/Bangumi.astro
import { siteConfig } from "../config";

const username = siteConfig.bangumiUser;
---

<div id="bangumi-widget" class="card-base p-4 w-full min-h-[220px] relative transition-all duration-500">
    
    <div class="flex items-center justify-between mb-4">
        <div class="font-bold text-lg text-neutral-900 dark:text-neutral-100 flex items-center gap-2 relative">
            <div class="w-1 h-4 rounded-md shrink-0" style="background-color: var(--primary);"></div>
            <span class="ml-1">è¿½ç•ª</span>
        </div>
        
        {/* ğŸŸ¢ ä¿®æ”¹é‡ç‚¹ï¼šé“¾æ¥æŒ‡å‘å†…éƒ¨é¡µé¢ /bangumi */}
        {/* å»æ‰äº† target="_blank"ï¼Œå®ç°ç«™å†…å¹³æ»‘è·³è½¬ */}
        <a href="/bangumi/" 
           class="opacity-60 hover:opacity-100 transition-opacity p-1"
           style="color: var(--primary);"
           aria-label="æŸ¥çœ‹æ›´å¤š">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"></path><path d="M12 5l7 7-7 7"></path></svg>
        </a>
    </div>

    <div id="bangumi-content" class="w-full h-full min-h-[150px] flex items-center justify-center">
        <div class="flex flex-col items-center justify-center gap-3 opacity-60">
            <div class="w-8 h-8 border-4 border-t-transparent rounded-full animate-spin" style="border-color: var(--primary); border-top-color: transparent; opacity: 0.3;"></div>
            <div class="text-xs text-neutral-400 animate-pulse">å°‘å¥³ç¥ˆç¥·ä¸­...</div>
        </div>
    </div>
</div>

<script is:inline define:vars={{ username }}>
    (async () => {
        const container = document.getElementById('bangumi-content');
        
        try {
            const apiUrl = `https://api.bgm.tv/v0/users/${username}/collections?subject_type=2&type=3&limit=6`;
            const response = await fetch(apiUrl);
            const data = await response.json();
            const list = data.data || [];

            if (list.length === 0) {
                container.innerHTML = `
                <div class="flex flex-col items-center justify-center py-6 text-center select-none">
                    <div class="text-xl mb-2 opacity-80" style="color: var(--primary);">_(:Ğ·ã€âˆ )_</div>
                    <p class="text-xs text-50">æœ€è¿‘åœ¨å·æ‡’ï¼Œæ²¡æœ‰è¿½ç•ªæ</p>
                </div>`;
                return;
            }

            const html = `
            <div class="grid grid-cols-3 gap-3 w-full animate-fade-in-up p-1">
                ${list.map(item => {
                    const subject = item.subject;
                    const title = subject.name_cn || subject.name;
                    const cover = subject.images.medium || subject.images.large;
                    const epStatus = item.ep_status;
                    const link = `https://bgm.tv/subject/${subject.id}`;

                    return `
                    <a href="${link}" target="_blank" 
                       class="
                          group relative block aspect-[2/3]
                          rounded-md overflow-hidden 
                          z-0
                          transition-all duration-300 
                          hover:-translate-y-1 hover:shadow-lg
                          will-change-transform
                        "
                       style="-webkit-mask-image: -webkit-radial-gradient(white, black);"
                       aria-label="${title}">
                        
                        <div class="absolute inset-0 bg-neutral-900"></div>

                        <img src="${cover}" 
                             class="absolute inset-0 w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                             style="backface-visibility: hidden;"
                             loading="lazy" 
                             alt="${title}" />
                        
                        <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/40 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-10"></div>

                        <div class="absolute top-0 right-0 text-white text-[9px] px-1.5 py-0.5 rounded-bl-md rounded-tr-md shadow-sm font-bold opacity-90 z-30" style="background-color: var(--primary);">
                            ${epStatus}è¯
                        </div>

                        <div class="absolute inset-x-0 bottom-0 p-2 opacity-0 group-hover:opacity-100 z-30 text-center transform translate-y-2 group-hover:translate-y-0 transition-all duration-300">
                            <p class="text-[9px] tracking-tight text-white font-medium leading-tight line-clamp-2 drop-shadow-md">${title}</p>
                        </div>
                    </a>
                    `;
                }).join('')}
            </div>
            `;

            container.style.opacity = '0';
            setTimeout(() => {
                container.innerHTML = html;
                container.style.transition = 'opacity 0.5s ease';
                container.style.opacity = '1';
            }, 300);

        } catch (e) {
            console.error('Bangumi Fetch Error:', e);
            container.innerHTML = `
            <div class="flex flex-col items-center justify-center h-full select-none">
                <div class="text-xs opacity-80 font-bold" style="color: var(--primary);">åŠ è½½å¤±è´¥ QAQ</div>
                <div class="text-[10px] text-neutral-400 mt-1 scale-90">è¯·æ£€æŸ¥ç½‘ç»œé…ç½®</div>
            </div>`;
        }
    })();
</script>

<style>
    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in-up {
        animation: fadeInUp 0.5s ease-out forwards;
    }
</style>