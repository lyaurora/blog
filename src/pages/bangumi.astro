---
// src/pages/bangumi.astro
export const prerender = false;

import Layout from "../layouts/MainGridLayout.astro";

// ------------------------------------------
// âœ… æ–°å¢ï¼šæ·»åŠ ç¼“å­˜æ§åˆ¶
// ------------------------------------------
// å‘Šè¯‰ CDNï¼šç¼“å­˜è¿™ä¸ªé¡µé¢ 3600 ç§’ï¼ˆ1å°æ—¶ï¼‰ã€‚
// åœ¨è¿™ 1 å°æ—¶å†…ï¼Œæ— è®ºå¤šå°‘äººè®¿é—®ï¼Œéƒ½ä¸ä¼šé‡æ–°è¯·æ±‚ Bangumi APIã€‚
Astro.response.headers.set(
	"Cache-Control",
	"public, max-age=0, s-maxage=3600, stale-while-revalidate=604800",
);

// ------------------------------------------
// âœ… 2. è·å–ç²¾ç¡®åˆ°ç§’çš„å½“å‰æ—¶é—´
// ------------------------------------------
const lastUpdateDate = new Date()
	.toLocaleString("zh-CN", {
		year: "numeric", // å¹´
		month: "2-digit", // æœˆ
		day: "2-digit", // æ—¥
		hour: "2-digit", // æ—¶
		minute: "2-digit", // åˆ†
		second: "2-digit", // ç§’ (æ–°å¢)
		hour12: false, // å¼ºåˆ¶ 24 å°æ—¶åˆ¶ (14:00 è€Œä¸æ˜¯ 2:00 PM)
		timeZone: "Asia/Shanghai", // é”å®šåŒ—äº¬æ—¶é—´
	})
	.replace(/\//g, "-"); // æŠŠ 2025/12/20 æ ¼å¼åŒ–ä¸º 2025-12-20

// ==========================================
// ğŸ”§ é…ç½®åŒºåŸŸ
// ==========================================
import { siteConfig } from "../config";

const USERNAME = siteConfig.bangumiUser;
const USER_AGENT = "sai/astro-blog-tracker";

// ==========================================
// ğŸ“ ç±»å‹å®šä¹‰
// ==========================================
interface BangumiSubject {
	id: number;
	name: string;
	name_cn: string;
	images: {
		large: string;
		common: string;
		medium: string;
		small: string;
		grid: string;
	};
	eps: number;
	score: number;
}

interface BangumiItem {
	subject: BangumiSubject;
	ep_status: number;
	rate: number;
}

interface BangumiCollection {
	label: string;
	type: number;
	limit: number;
	list: BangumiItem[];
}

// limit: 20
const collections: Partial<BangumiCollection>[] = [
	{ label: "æ­£åœ¨è¿½", type: 3, limit: 20 },
	{ label: "è¡¥ç•ªè®¡åˆ’", type: 1, limit: 20 },
	{ label: "å·²çœ‹å®Œ", type: 2, limit: 20 },
];

const results: BangumiCollection[] = await Promise.all(
	collections.map(async (col) => {
		try {
			if (!USERNAME) {
				return { ...col, list: [] } as BangumiCollection;
			}
			const url = `https://api.bgm.tv/v0/users/${USERNAME}/collections?subject_type=2&type=${col.type}&limit=${col.limit}`;
			const res = await fetch(url, { headers: { "User-Agent": USER_AGENT } });
			const json = await res.json();
			return { ...col, list: json.data || [] } as BangumiCollection;
		} catch (error) {
			console.error(`Fetch error for type ${col.type}:`, error);
			return { ...col, list: [] } as BangumiCollection;
		}
	}),
);
---

<Layout title="æˆ‘çš„ç•ªå‰§åº“">
  
  <div class="max-w-7xl mx-auto px-4 min-h-screen pt-24 pb-12">
    
    {/* é¡µé¢å¤§æ ‡é¢˜ */}
    <div class="mb-8 px-2">
      <div class="flex items-end justify-between border-b-2 border-gray-100 dark:border-neutral-800 pb-2">
        <div>
          <h1 class="text-2xl font-bold text-gray-900 dark:text-white tracking-tight">
            ç•ªå‰§æ”¶è—
          </h1>
          <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
            Synced from Bangumi â€¢
            <span class="font-mono text-gray-400 dark:text-gray-500">
              {lastUpdateDate}
            </span>
          </p>
        </div>
        <div class="text-right hidden sm:block">
          <div class="text-3xl font-bold text-gray-400 dark:text-neutral-600">
            {results.reduce((acc, cur) => acc + cur.list.length, 0)}
          </div>
        </div>
      </div>
    </div>

    {/* åˆ—è¡¨åŒºåŸŸ */}
    {results.map((group) => {
      if (group.list.length === 0) return null;

      return (
        <div class="mb-12">
          {/* åˆ†ç±»æ ‡é¢˜ï¼šä¿æŒä¾§è¾¹æ åŒæ¬¾æ ·å¼ */}
          <div class="flex items-center gap-2 mb-4 px-2">
            
            {/* ä¾§è¾¹æ é£æ ¼è£…é¥°æ¡ï¼šw-1 h-4 rounded-md + ä¸»é¢˜è‰² */}
            <div class="w-1 h-4 rounded-md shrink-0" style="background-color: var(--primary);"></div>
            
            <h2 class="text-lg font-bold text-gray-800 dark:text-gray-200">
              {group.label}
            </h2>
            
            <span class="text-xs font-mono text-gray-400 bg-gray-100 dark:bg-neutral-800 px-2 py-0.5 rounded-md ml-1">
              {group.list.length}
            </span>
          </div>

          <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6">
            {group.list.map((item: BangumiItem) => {
              const subject = item.subject;
              const title = subject.name_cn || subject.name;
              const cover = subject.images.large || subject.images.common;
              const url = `https://bgm.tv/subject/${subject.id}`;
              const progressText = `${item.ep_status} / ${subject.eps || '?'}`;
              const publicScore = subject.score; 
              const myScore = item.rate || 0;

              return (
                <a href={url} target="_blank" rel="noopener noreferrer" 
                   class="group relative block w-full aspect-[2/3] rounded-xl overflow-hidden shadow-md hover:shadow-2xl transition-all duration-300 hover:-translate-y-2 bg-gray-200 dark:bg-neutral-800 will-change-transform">
                  
                  <img 
                    src={cover} 
                    alt={title} 
                    class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"
                    loading="lazy"
                  />
                  
                  <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/40 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex flex-col justify-end p-4">
                    
                    <div class="transform translate-y-4 group-hover:translate-y-0 transition-transform duration-300 will-change-transform">
                      <h3 class="text-white font-bold text-lg leading-tight mb-2 line-clamp-2 drop-shadow-md">
                        {title}
                      </h3>
                      
                      <div class="flex items-center justify-between text-xs text-gray-300 antialiased">
                        <span class="bg-white/20 px-2 py-0.5 rounded border border-white/10">
                           {progressText}
                        </span>
                        
                        {myScore > 0 ? (
                          /* ğŸŸ¢ ä¿®å¤ç‚¹ï¼šæ”¹å› text-yellow-400ï¼Œå»æ‰ style ä¸»é¢˜è‰² */
                          <span class="text-yellow-400 font-bold flex items-center gap-1 drop-shadow-md bg-white/10 px-1.5 py-0.5 rounded">
                            â˜… {myScore}
                          </span>
                        ) : (
                          <span class="text-gray-400">æœªè¯„åˆ†</span>
                        )}
                      </div>
                    </div>
                  </div>

                  <div class="absolute top-2 left-2 bg-black/60 backdrop-blur-md text-white text-[10px] px-2 py-1 rounded-md border border-white/10 shadow-sm z-10 antialiased">
                    {item.ep_status}è¯
                  </div>

                  {publicScore && (
                     <div class="absolute top-2 right-2 flex items-center gap-1 z-10
                                 bg-neutral-900/80 backdrop-blur-md
                                 text-[10px] text-white
                                 px-2 py-0.5 rounded-md
                                 shadow-sm border border-white/10 antialiased">
                       <span class="text-neutral-400 text-[8px] uppercase tracking-wider font-semibold">Bgm</span>
                       <span class="font-bold text-yellow-400">{publicScore}</span>
                     </div>
                  )}
                </a>
              )
            })}
          </div>
        </div>
      );
    })}

    {results.every(g => g.list.length === 0) && (
      <div class="text-center py-20 text-gray-500">
        <p>ä¼¼ä¹æ— æ³•è¿æ¥åˆ° Bangumi æˆ–åˆ—è¡¨ä¸ºç©º...</p>
      </div>
    )}
  </div>
</Layout>